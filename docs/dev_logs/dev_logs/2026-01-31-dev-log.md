# 开发日志 - 2026-01-31

## 概要
在页面底部新增“反馈”入口，用户可直接在网页提交反馈并写入反馈数据库（本地 SQLite / 线上 Supabase），不依赖邮件客户端。

## 业务目的
- 提升反馈转化：降低用户提出建议的成本，缩短从“发现问题”到“可行动信息”的链路。
- 更快迭代：把真实用户在物理世界与日常生活中的问题更快汇聚到维护者。

## 变更清单（涉及文件）
- apps/web/src/components/FeedbackButton.tsx
  - 新增绿色“反馈”按钮与弹窗。
  - 调用 `/api/feedback` 提交反馈，由服务器写入反馈数据库。

- apps/web/src/app/api/feedback/route.ts
  - 新增反馈 API：接收 message/contact/pageUrl，并记录 user-agent/ip/referer 等信息。
  - 根据 `NEXT_PUBLIC_DATA_SOURCE` 写入本地 SQLite 或 Supabase 的 `feedback` 表。


- apps/web/scripts/local-init.mjs
  - 本地数据库新增 `feedback` 表（首次运行或缺表时自动创建）。

- apps/web/src/app/page.tsx
  - 在 footer 区域加入反馈按钮。

- apps/web/restart.sh
  - 去除硬编码路径，改为基于脚本所在目录定位应用目录。

- apps/web/deploy-ssh.sh
  - 新增一键 SSH 上线脚本：自动定位服务器应用目录并调用 restart.sh。
  - 修复 PM2 目录检测的 node -e 语法错误，改用 grep。
  - 新增 rsync 支持：当 git pull 失败（国内访问 GitHub 受限）时自动切换 rsync 同步代码。

## 验证
- 页面底部可见“反馈”按钮。
- 填写内容后点击“发送”，能成功写入反馈表（本地 SQLite）。

## 线上上线记录（自动化）
- 通过 SSH 公钥免密登录服务器，并执行自动化上线（install/build/pm2 restart）。
- 由于服务器侧无法稳定访问 GitHub（443 连接失败），改用 rsync 从本地同步代码到服务器目录 `/root/ai-era-human-thoughts/`。
- 服务器缺少编译工具导致 `better-sqlite3` 安装失败，已安装 `g++`/`make` 后恢复正常。
- Nginx 80 端口默认返回 404（访问 IP 时），已新增默认站点反代到 `http://127.0.0.1:3000`，公网访问恢复为 200。

## 备注
- 线上 Supabase 需要创建 `feedback` 表并配置插入策略（见 core/schema/001_initial_schema.sql）。
