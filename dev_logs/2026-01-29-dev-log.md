# 开发日志 - 2026-01-29

## 概要
为本地开发引入 SQLite 数据库（并支持单向同步到 Supabase），同时将前端从“直接连 Supabase”改为“统一 API 读写”，并稳定了本地启动脚本（避免端口冲突/锁文件问题）。

## 业务目的
- 本地可离线调试：不依赖 Supabase 可用性，提升开发效率。
- 线上保持一致：生产继续使用 Supabase，但提供可控的“本地 → 线上”同步通道。
- 降低出错成本：把运行期数据错误显性化（API 层兜底），减少“页面空白/控制台报错”带来的排障时间。

## 变更清单（涉及文件）
- apps/web/src/app/api/entries/route.ts
  - 新增统一 API：`GET`/`POST` 根据 `NEXT_PUBLIC_DATA_SOURCE` 选择本地 SQLite 或 Supabase。
  - 在开发环境默认走本地数据源（未配置 env 时避免 500）。
  - 新增署名 `author` 字段读写（空值默认“匿名”）。

- apps/web/src/components/EntryList.tsx
  - 改为从 `/api/entries` 拉取数据（不再在浏览器端直连 Supabase）。
  - 增加错误态提示与刷新事件机制。
  - 展示创建时间 `created_at`。
  - 展示署名 `author`（默认“匿名”）。
  - 优化元信息排版（Type / Created / Author），提升可读性。

- apps/web/src/components/SubmitEntry.tsx
  - 改为向 `/api/entries` 提交（不再在浏览器端直连 Supabase）。
  - 新增署名输入框（允许为空，空则为“匿名”）。

- apps/web/scripts/local-init.mjs
  - 初始化本地 SQLite 数据库与表结构。
  - 写入 mock 数据，并将 4 条 mock 数据署名设置为 `LLM MOCK`。
  - 自动补齐/迁移 `author` 列（兼容旧库）。

- apps/web/scripts/sync-to-supabase.mjs
  - 将本地 SQLite 数据单向 upsert 到 Supabase（包含 `author` 字段）。

- apps/web/dev.sh
  - 本地开发默认 `NEXT_PUBLIC_DATA_SOURCE=local`。
  - 启动前自动执行本地 DB 初始化脚本。
  - 自动处理端口占用/清理 Next dev 进程/清理 turbopack 缓存锁。

- apps/web/package.json
  - 新增脚本：`local:init`、`local:sync`。
  - 新增依赖：`better-sqlite3`（本地数据库）。
  - 新增类型：`@types/better-sqlite3`（TypeScript 兼容）。

- apps/web/.gitignore
  - 忽略本地数据库产物：`.local/`、`*.db`。

- core/schema/001_initial_schema.sql
  - Supabase 表结构新增 `author`（默认“匿名”），并将 4 条 mock 数据署名设为 `LLM MOCK`。

- docs/architecture/repository-structure.md
  - 记录本地数据库与脚本的位置，并在数据模型中补充 `Author(署名)`。
  - 增加 `dev_logs/` 目录说明。

## 本地数据源说明
- 本地 DB 路径：apps/web/.local/entries.db
- 本地默认数据源：NEXT_PUBLIC_DATA_SOURCE=local（dev.sh 会自动设置）
- 单向同步（本地 → Supabase）：在 apps/web 下执行 `npm run local:sync`

## 快照（回滚指引）
如需回滚本次改动，可按模块分组回退：
1) API + 前端读写改造
   - apps/web/src/app/api/entries/route.ts
   - apps/web/src/components/EntryList.tsx
   - apps/web/src/components/SubmitEntry.tsx

2) 本地数据库工具链
   - apps/web/scripts/local-init.mjs
   - apps/web/scripts/sync-to-supabase.mjs
   - apps/web/dev.sh
   - apps/web/package.json
   - apps/web/.gitignore

3) 数据库与文档
   - core/schema/001_initial_schema.sql
   - docs/architecture/repository-structure.md

## 备注
- Supabase 的 mock SQL 仍保留在 core/schema/001_initial_schema.sql，需要在 Supabase 控制台执行后才会生效。
- 本地开发时，API 会在缺表/缺列时自动创建与迁移，降低环境配置门槛。
